<!DOCTYPE html>
<html>
  <head>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.27.4/full/pyodide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ag-grid-community/dist/ag-grid-community.min.js"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
  </head>
  <body>
    <div class="container">
      <div class="vstack gap-3">
        <div class="p-2">
          <img src="bench_runner.png" width="800px" />
        </div>

        <div class="p-2">
          <h3>Head</h3>
          <div id="head_grid" style="height: 300px"></div>
        </div>

        <div class="p-2">
          <h3>Base</h3>
          <div id="quick_select" class="btn-group" role="group">
            <button
              type="button"
              class="btn btn-outline-primary"
              id="merge_base"
            >
              merge base
            </button>
          </div>
          <div id="base_grid" style="height: 300px"></div>
        </div>

        <div class="p-2">
          <nav style="--bs-breadcrumb-divider: '>'" aria-label="breadcrumb">
            <ol class="breadcrumb">
              <li id="ready" class="breadcrumb-item">
                <div class="spinner-border" role="status" />
              </li>
              <li id="head_ready" class="breadcrumb-item"></li>
              <li id="base_ready" class="breadcrumb-item"></li>
              <li class="breadcrumb-item">
                <button type="button" class="btn btn-primary" id="go">
                  Go
                </button>
              </li>
            </ol>
          </nav>
        </div>

        <div class="p-2">
          <div id="plot"></div>
        </div>
      </div>
    </div>

    <script type="text/javascript">
      const ORGANIZATION = "faster-cpython";
      const REPO = "benchmarking-public";
      const BRANCH = "main";
      const REPO_URL = `https://raw.githubusercontent.com/${ORGANIZATION}/${REPO}/refs/heads/${BRANCH}/results/`;

      let head_idx = null;
      let base_idx = null;
      let plot_diff = null;
      let worker = null;
      let python_ready = false;
      let gridOptions = null;
      let head_grid = null;
      let base_grid = null;

      function update_buttons() {
        document.querySelector("#go").disabled = !(
          python_ready &&
          head_idx !== null &&
          base_idx !== null
        );
        document.querySelector("#merge_base").disabled = !(
          head_idx !== null &&
          gridOptions !== null &&
          gridOptions._bases[head_idx] !== null
        );
        document.querySelector("#head_ready").innerHTML =
          head_idx === null ? "" : "Head";
        document.querySelector("#base_ready").innerHTML =
          base_idx === null ? "" : "Base";
      }

      async function setup_python() {
        let pyodide = await loadPyodide();
        let result = await Promise.all([
          fetch("bench_display.py").then((response) => {
            return response.text();
          }),
          pyodide.loadPackage("numpy"),
          pyodide.loadPackage("matplotlib"),
          pyodide.loadPackage(
            "https://files.pythonhosted.org/packages/19/29/ce5d2dcb095debb3bed0654950c45207a7d138e194abef0ded4b86de1dc1/pyperf-2.9.0-py3-none-any.whl"
          ),
          pyodide.loadPackage(
            "./bench_runner-1.6.4.dev6+g50e19d0.d20250401-py3-none-any.whl"
          ),
        ]);

        plot_diff = await pyodide.runPythonAsync(await result[0]);

        return pyodide;
      }

      async function setup_grid() {
        gridOptions = await fetch("index.json").then((response) => {
          return response.json();
        });

        let quick_select = document.querySelector("#quick_select");
        for (base of gridOptions._bases) {
          let button = document.createElement("button");
          button.type = "button";
          button.className = "btn btn-outline-primary";
          button.innerText = base;
          quick_select.appendChild(button);
          button.addEventListener("click", async (e) => {
            await base_grid.setColumnFilterModel("ref", {
              filterType: "text",
              type: "equals",
              filter: "v" + e.srcElement.innerText,
            });
            await base_grid.onFilterChanged();
          });
        }

        document
          .querySelector("#merge_base")
          .addEventListener("click", async () => {
            let base = gridOptions._base_results[head_idx];
            base_grid.forEachNode((node) => {
              if (node.sourceRowIndex == base) {
                node.setSelected(true);
                base_grid.ensureNodeVisible(node);
              } else {
                node.setSelected(false);
              }
            });
          });

        update_buttons();

        gridOptions.columnDefs = [
          { field: "date", filter: "agDateColumnFilter", width: 150 },
          { field: "hash", width: 100 },
          { field: "fork", width: 150 },
          { field: "ref", width: 150 },
          { field: "runner", width: 200 },
          { field: "flags", width: 150 },
        ];

        gridOptions.defaultColDef = {
          filter: "agTextColumnFilter",
          floatingFilter: true,
          sortable: true,
        };

        gridOptions.rowSelection = { mode: "singleRow" };

        gridOptions.onRowSelected = function (event) {
          if (event.node.isSelected()) {
            head_idx = event.node.sourceRowIndex;
          } else {
            head_idx = null;
          }
          update_buttons();
        };

        const head_grid_element = document.querySelector("#head_grid");
        head_grid = agGrid.createGrid(head_grid_element, gridOptions);

        gridOptions.onRowSelected = function (event) {
          if (event.node.isSelected()) {
            base_idx = event.node.sourceRowIndex;
          } else {
            base_idx = null;
          }
          update_buttons();
        };

        const base_grid_element = document.querySelector("#base_grid");
        base_grid = agGrid.createGrid(base_grid_element, gridOptions);

        document.querySelector("#go").addEventListener("click", async () => {
          document.querySelector("#go").innerHTML = "Loading...";
          let head_url = REPO_URL + gridOptions._index[head_idx];
          let base_url = REPO_URL + gridOptions._index[base_idx];
          let [head_data, base_data] = await Promise.all([
            fetch(head_url).then((response) => {
              return response.text();
            }),
            fetch(base_url).then((response) => {
              return response.text();
            }),
          ]);

          worker.postMessage([head_url, head_data, base_url, base_data]);
        });
      }

      async function main() {
        let grid = await setup_grid();

        worker = new Worker("worker.js", { type: "module" });

        worker.onmessage = (e) => {
          if (e.data == "READY") {
            console.log("READY");
            python_ready = true;
            document.querySelector("#ready").innerHTML = "Ready";
            update_buttons();
          } else {
            document.querySelector("#go").innerHTML = "Go";
            document.querySelector("#plot").innerHTML = e.data;
          }
        };
      }

      main();
    </script>
  </body>
</html>
